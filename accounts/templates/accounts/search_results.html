{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Résultats de recherche - Echop</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-red-50">
    <header class="bg-red-700 text-white p-6 text-center shadow-lg">
        <h1 class="text-3xl font-bold"><a href="{% url 'accounts:page_principale' %}" class="text-white hover:text-red-300">Echop</a></h1>
        <nav class="container mx-auto flex justify-between items-center mt-4">
            <ul class="flex space-x-6">
                <li><a href="{% url 'accounts:cart_detail' %}" class="text-white hover:text-red-300">Panier</a></li>
            </ul>
        </nav>
    </header>
    <main class="container mx-auto p-6">
        <h2 class="text-2xl font-semibold mb-4">Résultats pour : {{ query }}</h2>
        {% if products %}
            {% for product in products %}
                <div class="bg-white p-4 rounded-lg shadow-lg mb-4 flex items-center">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-32 h-32 object-cover rounded-lg mr-4">
                    {% else %}
                        <img src="{% static 'accounts/images/placeholder.jpg' %}" alt="Image non disponible" class="w-32 h-32 object-cover rounded-lg mr-4">
                    {% endif %}
                    <div>
                        <h3 class="text-xl font-semibold">{{ product.name }}</h3>
                        <p class="text-gray-600 mt-2">Prix : {{ product.price }} FCFA</p>
                        <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 mt-2 add-to-cart" data-product-id="{{ product.id }}">Ajouter au panier</button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>Aucun produit trouvé.</p>
        {% endif %}
    </main>
    <footer class="bg-red-700 text-white text-center py-6 mt-10">
        <p>© 2025 Echop. Tous droits réservés.</p>
        <p class="mt-1">Contact : support@echop.cm | Téléphone : +237 6 77 24 69 00</p>
        <div class="mt-2">
            <p>Suivez-nous :</p>
            <div class="flex justify-center space-x-4 mt-1">
                <a href="https://www.facebook.com/echopstore" class="text-white hover:text-red-300">Facebook</a>
                <a href="https://twitter.com/echopshop" class="text-white hover:text-red-300">Twitter</a>
                <a href="https://www.instagram.com/echop_official" class="text-white hover:text-red-300">Instagram</a>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    fetch(`/add-to-cart/${productId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken') // Nécessite la fonction getCookie ci-dessous
                        },
                        body: JSON.stringify({ action: 'add', quantity: 1 })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message); // Affiche un message de succès
                            // Optionnel : mets à jour un compteur de panier si tu as un élément .cart-count
                            const cartCount = document.querySelector('.cart-count');
                            if (cartCount && data.cart_item_count !== undefined) {
                                cartCount.textContent = data.cart_item_count;
                            }
                        } else {
                            alert('Erreur : ' + data.message);
                        }
                    })
                    .catch(error => console.error('Erreur :', error));
                });
            });

            // Fonction pour récupérer le token CSRF
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>